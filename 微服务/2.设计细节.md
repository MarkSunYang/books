1. 微服务分布式事物saga模式简介

名词：事务，分布式事务，XA协议，二阶段提交协议2pc，三阶段提交协议3pc，协调者
名词解释：
分布式系统中，每一个机器节点虽然知道自己执行事务的成功还是失败，但是却无法知道其他分布式节点的事务执行情况。
因此，当一个事务要跨越多个分布式节点的时候，为了保证该事务可以满足ACID，就要引入一个协调者（Cooradinator）。其他的节点被称为参与者（Participant）。协调者负责调度参与者的行为，并最终决定这些参与者是否要把事务进行提交。

比如一个人下订单的总金额不能超过这个人的信用卡授信额度，也就是说：一个人购买的商品总金额只能小于或等于他的信用卡授信额度。
我么可以想到的细节：
Product 
Order
Inventory

http://blog.51cto.com/4925054/2088726



a. 一段式提交协议：
提交 -> 数据库  Result：完成/未完成
一阶段提交协议相对简单，简单带来的优点就是，它不用再与其他的对象交互，节省了判断步骤和时间，所以在性能上是在阶段提交协议中对好的。
缺点：
数据库确认执行事务的时间较长，出问题的可能性就随之增大。
如果有多个数据源，一阶段提交协议无法协调他们之间的关系。

b. 二阶段提交协议2pc：
二阶段提交协议主要分为来个阶段：准备阶段和提交阶段。
2pc的操作过程:首先协调者会询问两个参与者是否能执行事务提交操作。如果两个参与者能够执行事务的提交，先执行事务操作，然后返回YES，如果没有成功执行事务操作，就返回NO。
二阶段提交协议的第一阶段准备阶段不仅仅是回答YES or NO，还是要执行事务操作的，只是执行完事务操作，并没有进行commit还是roolback。
一旦事务执行之后，在没有执行commit或者roolback之前，资源是被锁定的。这会造成阻塞。
2pc存在的问题：
这里暂且不谈2PC存在的同步阻塞、单点问题、脑裂等问题（上篇文章中有具体介绍），我们只讨论下数据一致性问题。作为一个分布式的一致性协议，我们主要关注他可能带来的一致性问题的。
2PC在执行过程中可能发生协调者或者参与者突然宕机的情况，在不同时期宕机可能有不同的现象。

c. 三阶段提交协议3pc：
3PC最关键要解决的就是协调者和参与者同时挂掉的问题，所以3PC把2PC的准备阶段再次一分为二，这样三阶段提交就有CanCommit、PreCommit、DoCommit三个阶段。在第一阶段，只是询问所有参与者是否可可以执行事务操作，并不在本阶段执行事务操作。当协调者收到所有的参与者都返回YES时，在第二阶段才执行事务操作，然后在第三阶段在执行commit或者rollback。


当协调者接收到所有的参与者的反馈之后，开始进入事务提交阶段。如果所有参与者都返回YES，那就发送COMMIT请求，如果有一个人返回NO，那就返送roolback请求。
3PC存在的问题：
在doCommit阶段，如果参与者无法及时接收到来自协调者的doCommit或者rebort请求时，会在等待超时之后，会继续进行事务的提交。

所以，由于网络原因，协调者发送的abort响应没有及时被参与者接收到，那么参与者在等待超时之后执行了commit操作。这样就和其他接到abort命令并执行回滚的参与者之间存在数据不一致的情况。


微服务为什么不能使用ACID？

因为每个微服务都拥有自己的私有数据库，比如订单服务有自己的订单数据库，而客户服务有自己的客户数据库，如果有一个业务操作需要跨订单和客户一起操作，


在微服务架构中，因为一个服务不能越过其他服务直接访问它们的数据库，两段提交可能不适用，当然EJB提供了基于容器的跨服务分布式事务，虽然听起来很容易，但是因为是同步操作，对网络硬件要求比较高，一旦发生事务出错，需要手工介入数据库进行强制回滚，如果跨N个服务调用出错，出错定位是非常困难的，很难判断问题出在哪个服务器或哪段通讯上，不可能进行时间和空间的同时定位。

那么一般使用JTA+XA方式跨订单数据库和客户数据库操作：

@Transactional //事物注解
public void crossAction(){
     //事物开始

     //这里ORDERS是属于订单服务的私有数据库
	 SELECT ORDER_TOTAL FROM ORDERS WHERE CUSTOMER_ID = ?
     //这里CUSTOMERS是属于客户服务的私有数据库
     SELECT CREDIT_LIMIT FROM CUSTOMERS WHERE CUSTOMER_ID=?
     INERT INTO ORDERS .....

     //提交事物
}

通过这段事务操作主要目的是为了维持业务上的不变性约束，比如一个人下订单的总金额不能超过这个人的信用卡授信额度，也就是说：一个人购买的商品总金额只能小于或等于他的信用卡授信额度。







事务提交协议：
https://blog.csdn.net/ggibenben1314/article/details/48812501

TCC
https://www.cnblogs.com/zengkefu/p/5742617.html

分布式事务Saga模式
https://www.jdon.com/49307